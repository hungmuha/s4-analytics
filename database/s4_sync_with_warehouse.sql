CREATE OR REPLACE PROCEDURE s4_sync_with_warehouse (p_days_back INT DEFAULT NULL)
AS
    v_start_dt DATE;
BEGIN
    v_start_dt := CASE WHEN p_days_back IS NOT NULL THEN TRUNC(SYSDATE - p_days_back) ELSE NULL END;

    -- crash_evt

    IF v_start_dt IS NULL THEN
        DELETE FROM crash_evt;
    ELSE
        DELETE FROM crash_evt evt
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_crash_evt@s4_warehouse vce
            WHERE vce.last_updt_dt >= v_start_dt
            AND vce.hsmv_rpt_nbr = evt.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO crash_evt (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_contrib_circum_env1,
        contrib_circum_env1,
        key_contrib_circum_env2,
        contrib_circum_env2,
        key_contrib_circum_env3,
        contrib_circum_env3,
        key_contrib_circum_rd1,
        contrib_circum_rd1,
        key_contrib_circum_rd2,
        contrib_circum_rd2,
        key_contrib_circum_rd3,
        contrib_circum_rd3,
        key_crash_sev,
        crash_sev,
        key_crash_sev_dtl,
        crash_sev_dtl,
        key_crash_type,
        crash_type,
        crash_type_simplified,
        crash_type_dir_tx,
        key_first_he,
        first_he,
        key_first_he_loc,
        first_he_loc,
        key_first_he_rel_to_jct,
        first_he_rel_to_jct,
        key_light_cond,
        light_cond,
        key_loc_in_work_zn,
        loc_in_work_zn,
        key_manner_of_collision,
        manner_of_collision,
        key_notif_by,
        notif_by,
        key_rd_sys_id,
        rd_sys_id,
        key_rd_surf_cond,
        rd_surf_cond,
        key_type_of_intrsect,
        type_of_intrsect,
        key_type_of_shoulder,
        type_of_shoulder,
        key_type_of_work_zn,
        type_of_work_zn,
        key_weather_cond,
        weather_cond,
        key_bike_ped_crash_type,
        key_bike_ped_crash_group,
        bike_ped_bike_or_ped,
        bike_ped_crash_grp_nbr,
        bike_ped_crash_grp_nm,
        bike_ped_crash_type_nbr,
        bike_ped_crash_type_nm,
        crash_tm,
        intrsect_st_nm,
        is_alc_rel,
        is_distracted,
        is_drug_rel,
        is_1st_he_within_intrchg,
        is_geolocated,
        is_le_in_work_zn,
        is_pictures_taken,
        is_sch_bus_rel,
        is_within_city_lim,
        is_workers_in_work_zn,
        is_work_zn_rel,
        milepost_nbr,
        offset_dir,
        offset_ft,
        rptg_ofcr_rank,
        st_nm,
        st_nbr,
        veh_cnt,
        moped_cnt,
        motorcycle_cnt,
        nm_cnt,
        pass_cnt,
        trailer_cnt,
        bike_cnt,
        ped_cnt,
        fatality_cnt,
        inj_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        veh_dmg_cnt,
        veh_dmg_amt,
        tot_dmg_amt,
        trans_by_ems_cnt,
        trans_by_le_cnt,
        trans_by_oth_cnt,
        inj_incapacitating_cnt,
        inj_none_cnt,
        inj_possible_cnt,
        inj_non_incapacitating_cnt,
        inj_fatal_30_cnt,
        inj_fatal_non_traffic_cnt,
        geo_status_cd,
        form_type_cd,
        agncy_rpt_nbr,
        batch_nbr,
        data_src_cd,
        is_complete,
        is_aggressive,
        rpt_dt,
        notif_tm,
        dispatched_tm,
        arrived_tm,
        cleared_tm,
        img_file_nm,
        img_src_nm,
        codeable,
        gps_pt_4326
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_contrib_circum_env1,
        contrib_circum_env1,
        key_contrib_circum_env2,
        contrib_circum_env2,
        key_contrib_circum_env3,
        contrib_circum_env3,
        key_contrib_circum_rd1,
        contrib_circum_rd1,
        key_contrib_circum_rd2,
        contrib_circum_rd2,
        key_contrib_circum_rd3,
        contrib_circum_rd3,
        key_crash_sev,
        crash_sev,
        key_crash_sev_dtl,
        crash_sev_dtl,
        key_crash_type,
        crash_type,
        crash_type_simplified,
        crash_type_dir_tx,
        key_first_he,
        first_he,
        key_first_he_loc,
        first_he_loc,
        key_first_he_rel_to_jct,
        first_he_rel_to_jct,
        key_light_cond,
        light_cond,
        key_loc_in_work_zn,
        loc_in_work_zn,
        key_manner_of_collision,
        manner_of_collision,
        key_notif_by,
        notif_by,
        key_rd_sys_id,
        rd_sys_id,
        key_rd_surf_cond,
        rd_surf_cond,
        key_type_of_intrsect,
        type_of_intrsect,
        key_type_of_shoulder,
        type_of_shoulder,
        key_type_of_work_zn,
        type_of_work_zn,
        key_weather_cond,
        weather_cond,
        key_bike_ped_crash_type,
        key_bike_ped_crash_group,
        bike_ped_bike_or_ped,
        bike_ped_crash_grp_nbr,
        bike_ped_crash_grp_nm,
        bike_ped_crash_type_nbr,
        bike_ped_crash_type_nm,
        crash_tm,
        intrsect_st_nm,
        is_alc_rel,
        is_distracted,
        is_drug_rel,
        is_1st_he_within_intrchg,
        is_geolocated,
        is_le_in_work_zn,
        is_pictures_taken,
        is_sch_bus_rel,
        is_within_city_lim,
        is_workers_in_work_zn,
        is_work_zn_rel,
        milepost_nbr,
        offset_dir,
        offset_ft,
        rptg_ofcr_rank,
        st_nm,
        st_nbr,
        veh_cnt,
        moped_cnt,
        motorcycle_cnt,
        nm_cnt,
        pass_cnt,
        trailer_cnt,
        bike_cnt,
        ped_cnt,
        fatality_cnt,
        inj_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        veh_dmg_cnt,
        veh_dmg_amt,
        tot_dmg_amt,
        trans_by_ems_cnt,
        trans_by_le_cnt,
        trans_by_oth_cnt,
        inj_incapacitating_cnt,
        inj_none_cnt,
        inj_possible_cnt,
        inj_non_incapacitating_cnt,
        inj_fatal_30_cnt,
        inj_fatal_non_traffic_cnt,
        geo_status_cd,
        form_type_cd,
        agncy_rpt_nbr,
        batch_nbr,
        data_src_cd,
        is_complete,
        is_aggressive,
        rpt_dt,
        notif_tm,
        dispatched_tm,
        arrived_tm,
        cleared_tm,
        img_file_nm,
        img_src_nm,
        codeable,
        gps_pt_4326
    FROM v_flat_crash_evt@s4_warehouse vce
    WHERE v_start_dt IS NULL
    OR vce.last_updt_dt >= v_start_dt;

    -- driver

    IF v_start_dt IS NULL THEN
        DELETE FROM driver;
    ELSE
        DELETE FROM driver dr
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_driver@s4_warehouse vd
            WHERE vd.last_updt_dt >= v_start_dt
            AND vd.hsmv_rpt_nbr = dr.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO driver (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_action1,
        action1,
        key_action2,
        action2,
        key_action3,
        action3,
        key_action4,
        action4,
        key_age_rng,
        age_rng,
        key_airbag_deployed,
        airbag_deployed,
        key_alc_test_result,
        alc_test_result,
        key_alc_test_type,
        alc_test_type,
        key_alc_tested,
        alc_tested,
        key_cond_at_tm_of_crash,
        cond_at_tm_of_crash,
        key_distracted_by,
        distracted_by,
        key_dl_endorsements,
        dl_endorsements,
        key_dl_type,
        dl_type,
        key_drug_test_result,
        drug_test_result,
        key_drug_test_type,
        drug_test_type,
        key_drug_tested,
        drug_tested,
        key_ejection,
        ejection,
        key_gender,
        gender,
        key_helmet_use,
        helmet_use,
        key_inj_sev,
        inj_sev,
        key_restraint_sys,
        restraint_sys,
        key_src_of_trans,
        src_of_trans,
        key_veh_body_type,
        veh_body_type,
        key_vision_obstruction,
        vision_obstruction,
        addr_city,
        addr_state,
        addr_zip,
        bac,
        dl_state,
        ins_co,
        is_alc_use_suspected,
        is_distracted,
        is_drug_use_suspected,
        is_using_eye_protection,
        is_re_exam_recommended,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_action1,
        action1,
        key_action2,
        action2,
        key_action3,
        action3,
        key_action4,
        action4,
        key_age_rng,
        age_rng,
        key_airbag_deployed,
        airbag_deployed,
        key_alc_test_result,
        alc_test_result,
        key_alc_test_type,
        alc_test_type,
        key_alc_tested,
        alc_tested,
        key_cond_at_tm_of_crash,
        cond_at_tm_of_crash,
        key_distracted_by,
        distracted_by,
        key_dl_endorsements,
        dl_endorsements,
        key_dl_type,
        dl_type,
        key_drug_test_result,
        drug_test_result,
        key_drug_test_type,
        drug_test_type,
        key_drug_tested,
        drug_tested,
        key_ejection,
        ejection,
        key_gender,
        gender,
        key_helmet_use,
        helmet_use,
        key_inj_sev,
        inj_sev,
        key_restraint_sys,
        restraint_sys,
        key_src_of_trans,
        src_of_trans,
        key_veh_body_type,
        veh_body_type,
        key_vision_obstruction,
        vision_obstruction,
        addr_city,
        addr_state,
        addr_zip,
        bac,
        dl_state,
        ins_co,
        is_alc_use_suspected,
        is_distracted,
        is_drug_use_suspected,
        is_using_eye_protection,
        is_re_exam_recommended,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr
    FROM v_flat_driver@s4_warehouse vd
    WHERE v_start_dt IS NULL
    OR vd.last_updt_dt >= v_start_dt;

    -- non_motorist

    IF v_start_dt IS NULL THEN
        DELETE FROM non_motorist;
    ELSE
        DELETE FROM non_motorist nm
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_non_motorist@s4_warehouse vnm
            WHERE vnm.last_updt_dt >= v_start_dt
            AND vnm.hsmv_rpt_nbr = nm.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO non_motorist (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_action_prior,
        action_prior,
        key_action_circum1,
        action_circum1,
        key_action_circum2,
        action_circum2,
        key_age_rng,
        age_rng,
        key_alc_test_result,
        alc_test_result,
        key_alc_test_type,
        alc_test_type,
        key_alc_tested,
        alc_tested,
        key_desc,
        "DESC",
        key_drug_test_result,
        drug_test_result,
        key_drug_test_type,
        drug_test_type,
        key_drug_tested,
        drug_tested,
        key_gender,
        gender,
        key_inj_sev,
        inj_sev,
        key_loc_at_tm_of_crash,
        loc_at_tm_of_crash,
        key_safety_eq1,
        safety_eq1,
        key_safety_eq2,
        safety_eq2,
        key_src_of_trans,
        src_of_trans,
        addr_city,
        addr_state,
        addr_zip,
        bac,
        dl_state,
        is_alc_use_suspected,
        is_drug_use_suspected,
        bike_cnt,
        ped_cnt,
        fatality_cnt,
        inj_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_action_prior,
        action_prior,
        key_action_circum1,
        action_circum1,
        key_action_circum2,
        action_circum2,
        key_age_rng,
        age_rng,
        key_alc_test_result,
        alc_test_result,
        key_alc_test_type,
        alc_test_type,
        key_alc_tested,
        alc_tested,
        key_desc,
        "DESC",
        key_drug_test_result,
        drug_test_result,
        key_drug_test_type,
        drug_test_type,
        key_drug_tested,
        drug_tested,
        key_gender,
        gender,
        key_inj_sev,
        inj_sev,
        key_loc_at_tm_of_crash,
        loc_at_tm_of_crash,
        key_safety_eq1,
        safety_eq1,
        key_safety_eq2,
        safety_eq2,
        key_src_of_trans,
        src_of_trans,
        addr_city,
        addr_state,
        addr_zip,
        bac,
        dl_state,
        is_alc_use_suspected,
        is_drug_use_suspected,
        bike_cnt,
        ped_cnt,
        fatality_cnt,
        inj_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr
    FROM v_flat_non_motorist@s4_warehouse vnm
    WHERE v_start_dt IS NULL
    OR vnm.last_updt_dt >= v_start_dt;

    -- pass

    IF v_start_dt IS NULL THEN
        DELETE FROM pass;
    ELSE
        DELETE FROM pass ps
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_pass@s4_warehouse vp
            WHERE vp.last_updt_dt >= v_start_dt
            AND vp.hsmv_rpt_nbr = ps.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO pass (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_age_rng,
        age_rng,
        key_airbag_deployed,
        airbag_deployed,
        key_ejection,
        ejection,
        key_gender,
        gender,
        key_helmet_use,
        helmet_use,
        key_inj_sev,
        inj_sev,
        key_restraint_sys,
        restraint_sys,
        key_seating_other,
        seating_other,
        key_seating_row,
        seating_row,
        key_seating_seat,
        seating_seat,
        key_src_of_trans,
        src_of_trans,
        key_veh_body_type,
        veh_body_type,
        addr_city,
        addr_state,
        addr_zip,
        dl_state,
        is_using_eye_protection,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        batch_nbr,
        inj_incapacitating_cnt,
        prop_dmg_amt
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        person_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_age_rng,
        age_rng,
        key_airbag_deployed,
        airbag_deployed,
        key_ejection,
        ejection,
        key_gender,
        gender,
        key_helmet_use,
        helmet_use,
        key_inj_sev,
        inj_sev,
        key_restraint_sys,
        restraint_sys,
        key_seating_other,
        seating_other,
        key_seating_row,
        seating_row,
        key_seating_seat,
        seating_seat,
        key_src_of_trans,
        src_of_trans,
        key_veh_body_type,
        veh_body_type,
        addr_city,
        addr_state,
        addr_zip,
        dl_state,
        is_using_eye_protection,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        batch_nbr,
        inj_incapacitating_cnt,
        prop_dmg_amt
    FROM v_flat_pass@s4_warehouse vp
    WHERE v_start_dt IS NULL
    OR vp.last_updt_dt >= v_start_dt;

    -- veh

    IF v_start_dt IS NULL THEN
        DELETE FROM veh;
    ELSE
        DELETE FROM veh
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_veh@s4_warehouse vv
            WHERE vv.last_updt_dt >= v_start_dt
            AND vv.hsmv_rpt_nbr = veh.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO veh (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_ar_of_init_impact,
        ar_of_init_impact,
        key_body_type,
        body_type,
        key_cargo_body_type,
        cargo_body_type,
        key_cmv_config,
        cmv_config,
        key_comm_non_comm,
        comm_non_comm,
        key_dmg_extent,
        dmg_extent,
        key_dir_before,
        dir_before,
        key_gvwr_gcwr,
        gvwr_gcwr,
        key_he1,
        he1,
        key_he2,
        he2,
        key_he3,
        he3,
        key_he4,
        he4,
        key_maneuver_action,
        maneuver_action,
        key_most_dmg_ar,
        most_dmg_ar,
        key_most_he,
        most_he,
        key_rd_align,
        rd_align,
        key_rd_grade,
        rd_grade,
        key_special_func,
        special_func,
        key_traffic_ctl,
        traffic_ctl,
        key_trafficway,
        trafficway,
        key_veh_defect1,
        veh_defect1,
        key_veh_defect2,
        veh_defect2,
        key_veh_type,
        veh_type,
        key_wrecker_sel,
        wrecker_sel,
        est_speed,
        is_comm_veh,
        is_emerg_veh,
        is_hazmat_released,
        is_hit_and_run,
        is_owner_a_business,
        is_perm_reg,
        is_towed_due_to_dmg,
        motor_carrier_city,
        motor_carrier_state,
        motor_carrier_zip,
        placard_hazmat_class,
        posted_speed,
        reg_state,
        tot_lanes,
        traveling_on_st,
        veh_color,
        veh_make,
        veh_model,
        veh_owner_city,
        veh_owner_state,
        veh_owner_zip,
        veh_style,
        veh_yr,
        moped_cnt,
        motorcycle_cnt,
        pass_cnt,
        trailer_cnt,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        veh_dmg_cnt,
        veh_dmg_amt,
        tot_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr,
        inj_none_cnt,
        inj_possible_cnt,
        inj_non_incapacitating_cnt,
        inj_fatal_30_cnt,
        inj_fatal_non_traffic_cnt
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        veh_nbr,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        key_ar_of_init_impact,
        ar_of_init_impact,
        key_body_type,
        body_type,
        key_cargo_body_type,
        cargo_body_type,
        key_cmv_config,
        cmv_config,
        key_comm_non_comm,
        comm_non_comm,
        key_dmg_extent,
        dmg_extent,
        key_dir_before,
        dir_before,
        key_gvwr_gcwr,
        gvwr_gcwr,
        key_he1,
        he1,
        key_he2,
        he2,
        key_he3,
        he3,
        key_he4,
        he4,
        key_maneuver_action,
        maneuver_action,
        key_most_dmg_ar,
        most_dmg_ar,
        key_most_he,
        most_he,
        key_rd_align,
        rd_align,
        key_rd_grade,
        rd_grade,
        key_special_func,
        special_func,
        key_traffic_ctl,
        traffic_ctl,
        key_trafficway,
        trafficway,
        key_veh_defect1,
        veh_defect1,
        key_veh_defect2,
        veh_defect2,
        key_veh_type,
        veh_type,
        key_wrecker_sel,
        wrecker_sel,
        est_speed,
        is_comm_veh,
        is_emerg_veh,
        is_hazmat_released,
        is_hit_and_run,
        is_owner_a_business,
        is_perm_reg,
        is_towed_due_to_dmg,
        motor_carrier_city,
        motor_carrier_state,
        motor_carrier_zip,
        placard_hazmat_class,
        posted_speed,
        reg_state,
        tot_lanes,
        traveling_on_st,
        veh_color,
        veh_make,
        veh_model,
        veh_owner_city,
        veh_owner_state,
        veh_owner_zip,
        veh_style,
        veh_yr,
        moped_cnt,
        motorcycle_cnt,
        pass_cnt,
        trailer_cnt,
        fatality_cnt,
        fatality_unrestrained_cnt,
        inj_cnt,
        inj_unrestrained_cnt,
        citation_cnt,
        citation_amt,
        prop_dmg_cnt,
        prop_dmg_amt,
        veh_dmg_cnt,
        veh_dmg_amt,
        tot_dmg_amt,
        inj_incapacitating_cnt,
        batch_nbr,
        inj_none_cnt,
        inj_possible_cnt,
        inj_non_incapacitating_cnt,
        inj_fatal_30_cnt,
        inj_fatal_non_traffic_cnt
    FROM v_flat_veh@s4_warehouse vv
    WHERE v_start_dt IS NULL
    OR vv.last_updt_dt >= v_start_dt;

    -- violation

    IF v_start_dt IS NULL THEN
        DELETE FROM violation;
    ELSE
        DELETE FROM violation vi
        WHERE EXISTS (
            SELECT 1
            FROM v_flat_violation@s4_warehouse vv
            WHERE vv.last_updt_dt >= v_start_dt
            AND vv.hsmv_rpt_nbr = vi.hsmv_rpt_nbr
        );
    END IF;

    INSERT INTO violation (
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        person_nbr,
        citation_nbr,
        citation_nbr_trunc,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        fl_statute_nbr,
        charge,
        batch_nbr
    )
    SELECT
        hsmv_rpt_nbr,
        hsmv_rpt_nbr_trunc,
        person_nbr,
        citation_nbr,
        citation_nbr_trunc,
        key_crash_dt,
        crash_yr,
        crash_mm,
        crash_mo,
        crash_dd,
        crash_day,
        key_geography,
        dot_district_nm,
        rpc_nm,
        mpo_nm,
        cnty_cd,
        cnty_nm,
        city_cd,
        city_nm,
        key_rptg_agncy,
        rptg_agncy_nm,
        rptg_agncy_short_nm,
        rptg_agncy_type,
        key_rptg_unit,
        rptg_unit_nm,
        rptg_unit_short_nm,
        fl_statute_nbr,
        charge,
        batch_nbr
    FROM v_flat_violation@s4_warehouse vv
    WHERE v_start_dt IS NULL
    OR vv.last_updt_dt >= v_start_dt;
END;
/
